name: PR Auto Review & Code Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, dev]

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° ìë™ ë¦¬ë·°
  code-quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.{js,jsx,ts,tsx}
            **/*.json
            **/*.md
          files_ignore: |
            node_modules/**
            .next/**
            .storybook/**
            public/**

      # TypeScript íƒ€ì… ì²´í¬
      - name: TypeScript Check
        id: typecheck
        run: |
          echo "ğŸ” TypeScript íƒ€ì… ê²€ì‚¬ ì¤‘..."
          pnpm run typecheck 2>&1 | tee typecheck.log || echo "typecheck_failed=true" >> $GITHUB_OUTPUT

      # ESLint ê²€ì‚¬
      - name: ESLint Check
        id: lint
        run: |
          echo "ğŸ” ESLint ê²€ì‚¬ ì¤‘..."
          pnpm run lint -- --format=json --output-file=eslint-report.json || echo "lint_failed=true" >> $GITHUB_OUTPUT
          pnpm run lint || true

      # Jest í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        id: test
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          pnpm run test -- --coverage --passWithNoTests --testResultsProcessor=jest-junit || echo "test_failed=true" >> $GITHUB_OUTPUT

      # í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ ì½”ë©˜íŠ¸
      - name: Comment Quality Check Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = `## ğŸ¤– ìë™ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼\n\n`;

            // TypeScript ê²€ì‚¬ ê²°ê³¼
            const typecheckFailed = '${{ steps.typecheck.outputs.typecheck_failed }}' === 'true';
            if (typecheckFailed) {
              comment += `âŒ **TypeScript íƒ€ì… ê²€ì‚¬**: ì‹¤íŒ¨\n`;
              try {
                const typecheckLog = fs.readFileSync('typecheck.log', 'utf8');
                comment += `\`\`\`\n${typecheckLog.slice(0, 1000)}...\n\`\`\`\n\n`;
              } catch (e) {}
            } else {
              comment += `âœ… **TypeScript íƒ€ì… ê²€ì‚¬**: í†µê³¼\n`;
            }

            // ESLint ê²€ì‚¬ ê²°ê³¼
            const lintFailed = '${{ steps.lint.outputs.lint_failed }}' === 'true';
            if (lintFailed) {
              comment += `âš ï¸ **ESLint ê²€ì‚¬**: ê°œì„  ì‚¬í•­ ë°œê²¬\n`;
            } else {
              comment += `âœ… **ESLint ê²€ì‚¬**: í†µê³¼\n`;
            }

            // í…ŒìŠ¤íŠ¸ ê²°ê³¼
            const testFailed = '${{ steps.test.outputs.test_failed }}' === 'true';
            if (testFailed) {
              comment += `âŒ **í…ŒìŠ¤íŠ¸**: ì‹¤íŒ¨\n`;
            } else {
              comment += `âœ… **í…ŒìŠ¤íŠ¸**: í†µê³¼\n`;
            }

            // ë³€ê²½ëœ íŒŒì¼ ì •ë³´
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ').filter(f => f);
            if (changedFiles.length > 0) {
              comment += `\nğŸ“ **ë³€ê²½ëœ íŒŒì¼** (${changedFiles.length}ê°œ):\n`;
              changedFiles.slice(0, 10).forEach(file => {
                comment += `- \`${file}\`\n`;
              });
              if (changedFiles.length > 10) {
                comment += `- ... ë° ${changedFiles.length - 10}ê°œ íŒŒì¼ ë”\n`;
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  # Copilot ë¦¬ë·° ìš”ì²­
  copilot-review:
    runs-on: ubuntu-latest
    needs: code-quality
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            // ë³€ê²½ì‚¬í•­ ë¶„ì„ì„ ìœ„í•œ ì •ë³´ ìˆ˜ì§‘
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // íŒŒì¼ íƒ€ì…ë³„ ë¶„ë¥˜
            const fileTypes = {
              components: files.filter(f => f.filename.includes('components/')),
              pages: files.filter(f => f.filename.includes('pages/') || f.filename.includes('app/')),
              utils: files.filter(f => f.filename.includes('utils/') || f.filename.includes('lib/')),
              types: files.filter(f => f.filename.includes('.types.') || f.filename.endsWith('.d.ts')),
              tests: files.filter(f => f.filename.includes('.test.') || f.filename.includes('.spec.')),
              stories: files.filter(f => f.filename.includes('.stories.')),
              config: files.filter(f => ['package.json', 'tsconfig.json', 'next.config.js', 'tailwind.config.js'].includes(f.filename.split('/').pop()))
            };

            let reviewRequest = `ğŸ¤– **GitHub Copilot ìë™ ë¦¬ë·° ìš”ì²­**

            @github-copilot ì•ˆë…•í•˜ì„¸ìš”! ë‹¤ìŒ PRì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:

            **ğŸ“‹ PR ì •ë³´:**
            - ì œëª©: ${pr.title}
            - ë³€ê²½ëœ íŒŒì¼: ${files.length}ê°œ
            - ì¶”ê°€ëœ ì¤„: +${pr.additions}
            - ì‚­ì œëœ ì¤„: -${pr.deletions}

            **ğŸ¯ ë¦¬ë·° í¬ì»¤ìŠ¤ ì˜ì—­:**`;

            // ë³€ê²½ëœ íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ ë¦¬ë·° ê°€ì´ë“œ
            if (fileTypes.components.length > 0) {
              reviewRequest += `\n- ğŸ§© **ì»´í¬ë„ŒíŠ¸** (${fileTypes.components.length}ê°œ): ì¬ì‚¬ìš©ì„±, props íƒ€ì…, ì ‘ê·¼ì„±`;
            }
            if (fileTypes.pages.length > 0) {
              reviewRequest += `\n- ğŸ“„ **í˜ì´ì§€/ë¼ìš°íŒ…** (${fileTypes.pages.length}ê°œ): SEO, ì„±ëŠ¥, ì‚¬ìš©ì ê²½í—˜`;
            }
            if (fileTypes.utils.length > 0) {
              reviewRequest += `\n- ğŸ”§ **ìœ í‹¸/ë¼ì´ë¸ŒëŸ¬ë¦¬** (${fileTypes.utils.length}ê°œ): í•¨ìˆ˜ ìˆœìˆ˜ì„±, ì—ëŸ¬ í•¸ë“¤ë§`;
            }
            if (fileTypes.types.length > 0) {
              reviewRequest += `\n- ğŸ·ï¸ **íƒ€ì… ì •ì˜** (${fileTypes.types.length}ê°œ): íƒ€ì… ì•ˆì •ì„±, ì¸í„°í˜ì´ìŠ¤ ì„¤ê³„`;
            }
            if (fileTypes.tests.length > 0) {
              reviewRequest += `\n- ğŸ§ª **í…ŒìŠ¤íŠ¸** (${fileTypes.tests.length}ê°œ): í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€, í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤`;
            }
            if (fileTypes.stories.length > 0) {
              reviewRequest += `\n- ğŸ“– **ìŠ¤í† ë¦¬ë¶** (${fileTypes.stories.length}ê°œ): ìŠ¤í† ë¦¬ ì™„ì„±ë„, ë¬¸ì„œí™”`;
            }

            reviewRequest += `

            **ğŸ” íŠ¹ë³„íˆ í™•ì¸í•´ ì£¼ì„¸ìš”:**
            - Next.js 15.3.1 ìµœì í™” ê¸°íšŒ
            - React 18.3.1 ë™ì‹œì„± ê¸°ëŠ¥ í™œìš©
            - TypeScript íƒ€ì… ì•ˆì •ì„±
            - Tailwind CSS í´ë˜ìŠ¤ ìµœì í™”
            - ì„±ëŠ¥ ë° ì ‘ê·¼ì„± ì´ìŠˆ
            - ë³´ì•ˆ ì·¨ì•½ì 

            **ğŸ“š í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
            - Next.js + TypeScript + TanStack Query + Tailwind CSS
            - í…ŒìŠ¤íŒ…: Jest + Testing Library
            - ìŠ¤í† ë¦¬ë¶ ë¬¸ì„œí™”
            - Radix UI ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©

            ë¦¬ë·° ì™„ë£Œ í›„ ê°œì„  ì œì•ˆì‚¬í•­ì„ ì•Œë ¤ì£¼ì„¸ìš”! ğŸ™`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewRequest
            });

  # Storybook ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì„ íƒì )
  storybook-check:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, '.stories.')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Storybook
        run: |
          echo "ğŸ“– Storybook ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
          pnpm run build-storybook

      - name: Comment Storybook Status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âœ… **Storybook ë¹Œë“œ**: ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            });
